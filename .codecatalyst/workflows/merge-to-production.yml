Name: Merge-to-Production-Deployment
SchemaVersion: "1.0"

# This workflow ONLY triggers on pushes to main branch (after merge approval)
Triggers:
  - Type: PUSH
    Branches:
      - main

Actions:
  # Pre-deployment validation
  PreDeploymentCheck:
    Identifier: aws/build@v1
    Inputs:
      Sources:
        - WorkflowSource
    Configuration:
      Commands:
        - echo "ðŸ” Pre-Deployment Validation"
        - echo "============================="
        - echo "âœ… Triggered by merge to main branch"
        - echo "ðŸ“… Deployment time: $(date)"
        - echo "ðŸ·ï¸  Commit: ${WorkflowSource.CommitId}"
        - echo "ðŸ‘¤ Author: ${WorkflowSource.CommitAuthor}"
        - echo "ðŸ“ Commit message: ${WorkflowSource.CommitMessage}"
        - echo ""
        - echo "ðŸš€ Starting production deployment pipeline..."
        - echo "============================="

  # Install just command runner
  InstallJust:
    Identifier: aws/build@v1
    DependsOn:
      - PreDeploymentCheck
    Inputs:
      Sources:
        - WorkflowSource
    Configuration:
      Commands:
        - echo "ðŸ“¦ Installing just command runner..."
        - curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin
        - chmod +x /usr/local/bin/just
        - just --version
        - echo "âœ… just installed successfully"
    Outputs:
      Artifacts:
        - Name: just-binary
          Files:
            - "/usr/local/bin/just"

  # Final validation before production deployment
  FinalValidation:
    Identifier: aws/build@v1
    DependsOn:
      - InstallJust
    Inputs:
      Sources:
        - WorkflowSource
      Artifacts:
        - just-binary
    Configuration:
      Commands:
        - echo "ðŸ”¬ Final validation before production deployment..."
        - cp /usr/local/bin/just /usr/local/bin/just || true
        - chmod +x /usr/local/bin/just
        - export PATH="/usr/local/bin:$PATH"
        - echo "Checking prerequisites..."
        - just check-prerequisites
        - echo "Running CDK synth validation..."
        - just cdk-synth
        - echo "âœ… Final validation passed - proceeding with production deployment"

  # Production deployment
  ProductionDeployment:
    Identifier: aws/build@v1
    DependsOn:
      - FinalValidation
    Environment:
      Name: production
      Connections:
        - Name: aws-connection
          Role: CodeCatalystWorkflowDevelopmentRole-AWSCocha
    Inputs:
      Sources:
        - WorkflowSource
      Artifacts:
        - just-binary
    Configuration:
      Commands:
        - echo "ðŸš€ PRODUCTION DEPLOYMENT STARTED"
        - echo "================================="
        - echo "âš ï¸  Deploying to PRODUCTION environment"
        - echo "ðŸ”’ This deployment was triggered by an approved merge to main"
        - echo ""
        - cp /usr/local/bin/just /usr/local/bin/just || true
        - chmod +x /usr/local/bin/just
        - export PATH="/usr/local/bin:$PATH"
        - echo "ðŸ—ï¸  Deploying infrastructure..."
        - just deploy-infrastructure-full
        - echo "ðŸ§ª Testing API endpoints..."
        - just test-api
        - echo "ðŸŽ¨ Deploying frontend..."
        - just deploy-frontend-full
        - echo "ðŸŒ Testing frontend..."
        - just test-frontend
        - echo "ðŸ“Š Creating test data..."
        - just create-test-data
        - echo "âœ… PRODUCTION DEPLOYMENT COMPLETED"
    Outputs:
      Artifacts:
        - Name: production-deployment-outputs
          Files:
            - outputs.json
            - deployment-outputs.env

  # Post-deployment validation
  PostDeploymentValidation:
    Identifier: aws/build@v1
    DependsOn:
      - ProductionDeployment
    Environment:
      Name: production
      Connections:
        - Name: aws-connection
          Role: CodeCatalystWorkflowDevelopmentRole-AWSCocha
    Inputs:
      Sources:
        - WorkflowSource
      Artifacts:
        - just-binary
        - production-deployment-outputs
    Configuration:
      Commands:
        - echo "ðŸ” Post-Deployment Validation"
        - echo "============================="
        - cp /usr/local/bin/just /usr/local/bin/just || true
        - chmod +x /usr/local/bin/just
        - export PATH="/usr/local/bin:$PATH"
        - cp deployment-outputs.env deployment-outputs.env
        - echo "ðŸ§ª Running comprehensive validation..."
        - just validate-deployment
        - echo "ðŸƒâ€â™‚ï¸ Running integration tests..."
        - source deployment-outputs.env
        - echo "Testing API health endpoint..."
        - curl -f "$API_URL/health" || exit 1
        - echo "Testing API people endpoint..."
        - curl -f "$API_URL/people" || exit 1
        - echo "Testing frontend accessibility..."
        - curl -f -I "$FRONTEND_URL" || exit 1
        - echo "Verifying test data..."
        - PEOPLE_COUNT=$(curl -s "$API_URL/people" | jq length)
        - echo "People count: $PEOPLE_COUNT"
        - if [ "$PEOPLE_COUNT" -lt 1 ]; then echo "âŒ No people found, test failed"; exit 1; fi
        - echo "âœ… All post-deployment validations passed!"

  # Deployment success notification
  DeploymentSuccessNotification:
    Identifier: aws/build@v1
    DependsOn:
      - PostDeploymentValidation
    Inputs:
      Sources:
        - WorkflowSource
      Artifacts:
        - production-deployment-outputs
    Configuration:
      Commands:
        - echo "ðŸŽ‰ PRODUCTION DEPLOYMENT SUCCESS"
        - echo "================================="
        - echo "âœ… Production deployment completed successfully!"
        - echo ""
        - echo "ðŸ“‹ Deployment Details:"
        - echo "  ðŸ”— Triggered by: Approved merge to main branch"
        - echo "  ðŸ“… Deployment time: $(date)"
        - echo "  ðŸ·ï¸  Commit: ${WorkflowSource.CommitId}"
        - echo "  ðŸ‘¤ Author: ${WorkflowSource.CommitAuthor}"
        - echo "  ðŸ“ Message: ${WorkflowSource.CommitMessage}"
        - echo ""
        - source deployment-outputs.env
        - echo "ðŸŒ Application URLs:"
        - echo "  ðŸŽ¨ Frontend: $FRONTEND_URL"
        - echo "  ðŸ”§ API: $API_URL"
        - echo ""
        - echo "ðŸ“Š System Status:"
        - echo "  âœ… Infrastructure: Deployed"
        - echo "  âœ… API: Operational"
        - echo "  âœ… Frontend: Accessible"
        - echo "  âœ… Integration Tests: Passed"
        - echo ""
        - echo "ðŸŽ¯ Next Steps:"
        - echo "  â€¢ Monitor application performance"
        - echo "  â€¢ Check CloudWatch logs if needed"
        - echo "  â€¢ Verify user functionality"
        - echo "================================="

  # Generate deployment report
  GenerateDeploymentReport:
    Identifier: aws/build@v1
    DependsOn:
      - DeploymentSuccessNotification
    Inputs:
      Sources:
        - WorkflowSource
      Artifacts:
        - production-deployment-outputs
    Configuration:
      Commands:
        - echo "ðŸ“„ Generating deployment report..."
        - source deployment-outputs.env
        - echo "# Production Deployment Report" > deployment-report.md
        - echo "" >> deployment-report.md
        - echo "## Deployment Summary" >> deployment-report.md
        - echo "- **Deployment Date:** $(date)" >> deployment-report.md
        - echo "- **Trigger:** Approved merge to main branch" >> deployment-report.md
        - echo "- **Commit:** ${WorkflowSource.CommitId}" >> deployment-report.md
        - echo "- **Author:** ${WorkflowSource.CommitAuthor}" >> deployment-report.md
        - echo "- **Message:** ${WorkflowSource.CommitMessage}" >> deployment-report.md
        - echo "" >> deployment-report.md
        - echo "## Infrastructure Details" >> deployment-report.md
        - echo "- **Stack Name:** PeopleRegisterInfrastructureStack" >> deployment-report.md
        - echo "- **API URL:** $API_URL" >> deployment-report.md
        - echo "- **Frontend URL:** $FRONTEND_URL" >> deployment-report.md
        - echo "- **S3 Bucket:** $S3_BUCKET" >> deployment-report.md
        - echo "- **DynamoDB Table:** $DYNAMODB_TABLE" >> deployment-report.md
        - echo "- **CloudFront Distribution:** $DISTRIBUTION_ID" >> deployment-report.md
        - echo "" >> deployment-report.md
        - echo "## Validation Results" >> deployment-report.md
        - echo "- **API Health Check:** âœ… PASSED" >> deployment-report.md
        - echo "- **Frontend Accessibility:** âœ… PASSED" >> deployment-report.md
        - echo "- **Integration Tests:** âœ… PASSED" >> deployment-report.md
        - echo "- **Test Data Creation:** âœ… PASSED" >> deployment-report.md
        - echo "" >> deployment-report.md
        - echo "## Deployment Process" >> deployment-report.md
        - echo "1. âœ… Pre-deployment validation" >> deployment-report.md
        - echo "2. âœ… Infrastructure deployment" >> deployment-report.md
        - echo "3. âœ… API testing" >> deployment-report.md
        - echo "4. âœ… Frontend deployment" >> deployment-report.md
        - echo "5. âœ… Frontend testing" >> deployment-report.md
        - echo "6. âœ… Test data creation" >> deployment-report.md
        - echo "7. âœ… Post-deployment validation" >> deployment-report.md
        - echo "8. âœ… Integration testing" >> deployment-report.md
        - echo "" >> deployment-report.md
        - echo "## Status: ðŸŽ‰ SUCCESS" >> deployment-report.md
        - cat deployment-report.md
        - echo "ðŸ“„ Deployment report generated successfully"
    Outputs:
      Artifacts:
        - Name: deployment-report
          Files:
            - deployment-report.md
            - deployment-outputs.env
