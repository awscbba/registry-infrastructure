Name: Infrastructure_Deployment_Pipeline
SchemaVersion: "1.0"

Triggers:
  - Type: PUSH
    Branches:
      - main
  - Type: PULLREQUEST
    Branches:
      - main
    Events:
      - OPEN
      - REVISION
  - Type: MANUAL

Actions:
  ValidateInfrastructure:
    Identifier: aws/build@v1
    Compute:
      Type: EC2
    Environment:
      Connections:
        - Role: CodeCatalystWorkflowDevelopmentRole-AWSCocha
          Name: "142728997126"
      Name: AWS
    Inputs:
      Sources:
        - WorkflowSource
    Configuration:
      Steps:
        - Run: |
            echo "‚ö° Infrastructure Validation (Simplified)"
            echo "========================================"
            echo "üìÖ Stage Start: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo ""

            # Set execution mode environment variables (simplified)
            export EXECUTION_MODE="validation"
            export TRIGGER_TYPE="${CODECATALYST_TRIGGER_TYPE:-PULLREQUEST}"
            export BRANCH_NAME="${CODECATALYST_SOURCE_BRANCH_NAME:-feature-branch}"
            export IS_MAIN_BRANCH="false"
            export SKIP_DEPLOYMENT="true"
            export SKIP_TESTING="true"

            echo "üéØ Mode: $EXECUTION_MODE (fast feedback for PR)"
            echo ""

            # Minimal validation - just check if CDK code compiles
            echo "üîÑ CDK Synthesis Check..."

            # Install CDK and dependencies (use older version that supports Node 18)
            npm install -g aws-cdk@2.60.0 > /dev/null 2>&1
            python3 -m venv .venv > /dev/null 2>&1
            source .venv/bin/activate
            pip install -r requirements.txt > /dev/null 2>&1

            # Suppress Node.js end-of-life warnings for CDK
            export CDK_DISABLE_VERSION_CHECK=1
            export NODE_NO_WARNINGS=1

            # The only check that matters: Does CDK compile?
            # Capture both stdout and stderr to analyze the output
            echo "Running CDK synthesis..."
            cdk synth > cdk-synth-output.txt 2>cdk-synth-errors.txt
            CDK_EXIT_CODE=$?

            # Check if the failure is just due to Node.js warnings
            if [ $CDK_EXIT_CODE -eq 0 ]; then
                echo "‚úÖ CDK synthesis successful - Infrastructure is valid"
                VALIDATION_STATUS="success"
            elif grep -q "Node.*has reached end-of-life" cdk-synth-errors.txt; then
                echo "‚ö†Ô∏è Node.js end-of-life warning detected - checking if synthesis actually succeeded..."
                
                # Check if CDK actually generated templates despite the warning
                if ls cdk.out/*.template.json >/dev/null 2>&1 || ls cdk.out/*.template.yaml >/dev/null 2>&1; then
                    echo "‚úÖ CDK synthesis succeeded despite Node.js warnings (CloudFormation templates found)"
                    echo "üìã Node.js warning is informational only - infrastructure is valid"
                    VALIDATION_STATUS="success"
                else
                    echo "‚ùå CDK synthesis failed - no CloudFormation templates generated"
                    echo ""
                    echo "Error details:"
                    head -20 cdk-synth-errors.txt
                    echo ""
                    VALIDATION_STATUS="failed"
                fi
            else
                echo "‚ùå CDK synthesis failed - Infrastructure has real errors"
                echo ""
                echo "Error details:"
                head -20 cdk-synth-errors.txt
                echo ""
                VALIDATION_STATUS="failed"
            fi

            # Create artifacts based on validation status
            if [ "$VALIDATION_STATUS" = "success" ]; then
                echo '{"status":"success","execution_mode":"validation"}' > validation-results.json
                echo "CDK Synthesis: SUCCESS" > validation-report.txt
                echo '{"synthesis":"success"}' > cdk-synth-output.json
            else
                echo '{"status":"failed","execution_mode":"validation"}' > validation-results.json
                echo "CDK Synthesis: FAILED" > validation-report.txt
                echo '{"synthesis":"failed"}' > cdk-synth-output.json
                exit 1
            fi

            echo ""
            echo "üìä Stage: ValidateInfrastructure - COMPLETED"
            echo "‚è±Ô∏è Duration: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
      Container:
        Registry: CODECATALYST
        Image: CodeCatalystLinux_x86_64:2024_03
    Outputs:
      Artifacts:
        - Name: validationResults
          Files:
            - "validation-results.json"
            - "validation-report.txt"
            - "cdk-synth-output.json"
            - "cdk-synth-errors.txt"