Name: Deploy Infrastructure
SchemaVersion: "1.0"

# Global environment variables for the entire workflow
Environment:
  Variables:
    # Project Configuration
    PROJECT_NAME: "people-registry"
    STACK_NAME: "PeopleRegisterInfrastructureStack"
    AWS_REGION: "us-west-2"
    ENVIRONMENT: "production"
    
    # Project-Specific Infrastructure Settings
    DYNAMODB_TABLE_PREFIX: "PeopleRegister"
    S3_BUCKET_PREFIX: "people-register"
    LAMBDA_FUNCTION_PREFIX: "PeopleRegister"
    API_GATEWAY_NAME: "PeopleRegisterAPI"
    CLOUDFRONT_COMMENT: "People Register Frontend Distribution"
    
    # Project-Specific Resource Configuration
    DYNAMODB_BILLING_MODE: "PAY_PER_REQUEST"
    LAMBDA_RUNTIME: "python3.11"
    LAMBDA_TIMEOUT: "30"
    LAMBDA_MEMORY: "256"
    API_GATEWAY_STAGE: "prod"
    
    # Project-Specific Domain and Naming
    APPLICATION_NAME: "People Register"
    APPLICATION_VERSION: "1.0.0"
    ORGANIZATION: "AWSCocha"
    COST_CENTER: "UserGroup"
    
    # Tool Versions
    PYTHON_VERSION: "3.11"
    NODE_VERSION: "18"
    CDK_VERSION: "latest"
    
    # Deployment Configuration
    REQUIRE_APPROVAL: "never"
    OUTPUTS_FILE: "outputs.json"
    DEPLOYMENT_OUTPUTS_FILE: "deployment-outputs.env"
    
    # Project-Specific Timeouts
    HEALTH_CHECK_TIMEOUT: "30"
    INTEGRATION_TEST_TIMEOUT: "60"
    DEPLOYMENT_TIMEOUT: "1800"
    CDK_DEPLOY_TIMEOUT: "1200"
    
    # Project-Specific Testing
    TEST_DATA_COUNT: "5"
    PERFORMANCE_THRESHOLD: "2000"
    AVAILABILITY_THRESHOLD: "99.9"

# Only trigger on push to main (after merge) and PR validation
Triggers:
  - Type: PUSH
    Branches:
      - main
  - Type: PULLREQUEST
    Branches:
      - main
    Events:
      - OPEN
      - REVISION

Actions:
  # Install just command runner
  InstallJust:
    Identifier: aws/build@v1
    Inputs:
      Sources:
        - WorkflowSource
    Configuration:
      Commands:
        - echo "Installing just command runner..."
        - curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin
        - just --version
        - echo "‚úÖ just installed successfully"
    Outputs:
      Artifacts:
        - Name: just-binary
          Files:
            - "/usr/local/bin/just"

  # Validate infrastructure code (runs on PRs and main pushes)
  ValidateInfrastructure:
    Identifier: aws/build@v1
    DependsOn:
      - InstallJust
    Inputs:
      Sources:
        - WorkflowSource
      Artifacts:
        - just-binary
    Configuration:
      Commands:
        - echo "Setting up environment..."
        - cp /usr/local/bin/just /usr/local/bin/just || true
        - chmod +x /usr/local/bin/just
        - export PATH="/usr/local/bin:$PATH"
        - echo "üîç Validating infrastructure for $APPLICATION_NAME ($PROJECT_NAME)"
        - echo "Stack: $STACK_NAME | Region: $AWS_REGION | Environment: $ENVIRONMENT"
        - echo "Version: $APPLICATION_VERSION | Organization: $ORGANIZATION"
        - echo "DynamoDB: $DYNAMODB_BILLING_MODE | Lambda: $LAMBDA_RUNTIME ($LAMBDA_MEMORY MB)"
        - echo "Checking prerequisites..."
        - just check-prerequisites
        - echo "Running CDK synth to validate..."
        - just cdk-synth
        - echo "Running unit tests..."
        - source .venv/bin/activate && python -m pytest tests/ -v || echo "No tests found"
        - echo "‚úÖ Infrastructure validation completed"
    Outputs:
      Reports:
        - Name: test-results
          Format: JUNITXML
          IncludePaths:
            - "test-results.xml"

  # Deploy to production environment (ONLY on main branch push after merge)
  DeployProduction:
    Identifier: aws/build@v1
    DependsOn:
      - ValidateInfrastructure
    Environment:
      Name: production
      Connections:
        - Name: aws-connection
          Role: CodeCatalystWorkflowDevelopmentRole-AWSCocha
    Inputs:
      Sources:
        - WorkflowSource
      Artifacts:
        - just-binary
    Configuration:
      Commands:
        - echo "üöÄ Starting production deployment after merge to main..."
        - echo "Application: $APPLICATION_NAME v$APPLICATION_VERSION"
        - echo "Project: $PROJECT_NAME | Stack: $STACK_NAME | Region: $AWS_REGION"
        - echo "Organization: $ORGANIZATION | Cost Center: $COST_CENTER"
        - echo "Lambda: $LAMBDA_RUNTIME ($LAMBDA_MEMORY MB, ${LAMBDA_TIMEOUT}s timeout)"
        - echo "API Gateway: $API_GATEWAY_NAME ($API_GATEWAY_STAGE stage)"
        - echo "Setting up environment..."
        - cp /usr/local/bin/just /usr/local/bin/just || true
        - chmod +x /usr/local/bin/just
        - export PATH="/usr/local/bin:$PATH"
        - echo "Deploying infrastructure to production..."
        - timeout $CDK_DEPLOY_TIMEOUT just deploy-infrastructure-full
        - echo "Testing API endpoints..."
        - just test-api
        - echo "Creating $TEST_DATA_COUNT test records..."
        - just create-test-data
        - echo "Saving deployment outputs..."
        - cp $OUTPUTS_FILE deployment-outputs-prod.json
        - cp $DEPLOYMENT_OUTPUTS_FILE deployment-outputs-prod.env
        - echo "Printing deployment summary..."
        - just print-deployment-summary
        - echo "‚úÖ Production infrastructure deployment completed"
    Outputs:
      Artifacts:
        - Name: prod-infrastructure-outputs
          Files:
            - deployment-outputs-prod.json
            - deployment-outputs-prod.env
    # CRITICAL: Only run on main branch pushes (after merge approval)
    Condition:
      StringEquals:
        - "${WorkflowSource.BranchName}"
        - "main"

  # Deploy frontend after infrastructure (ONLY on main branch push after merge)
  DeployFrontend:
    Identifier: aws/build@v1
    DependsOn:
      - DeployProduction
    Environment:
      Name: production
      Connections:
        - Name: aws-connection
          Role: CodeCatalystWorkflowDevelopmentRole-AWSCocha
    Inputs:
      Sources:
        - WorkflowSource
      Artifacts:
        - just-binary
        - prod-infrastructure-outputs
    Configuration:
      Commands:
        - echo "üé® Starting frontend deployment after infrastructure..."
        - echo "Project: $PROJECT_NAME | Environment: $ENVIRONMENT"
        - echo "Setting up environment..."
        - cp /usr/local/bin/just /usr/local/bin/just || true
        - chmod +x /usr/local/bin/just
        - export PATH="/usr/local/bin:$PATH"
        - echo "Restoring deployment outputs..."
        - cp deployment-outputs-prod.env $DEPLOYMENT_OUTPUTS_FILE
        - echo "Deploying frontend..."
        - just deploy-frontend-full
        - echo "Testing frontend..."
        - just test-frontend
        - echo "Validating complete deployment..."
        - just validate-deployment
        - echo "Final deployment summary..."
        - just print-deployment-summary
        - echo "‚úÖ Frontend deployment completed"
    # CRITICAL: Only run on main branch pushes (after merge approval)
    Condition:
      StringEquals:
        - "${WorkflowSource.BranchName}"
        - "main"

  # Integration tests (ONLY on main branch push after merge)
  IntegrationTests:
    Identifier: aws/build@v1
    DependsOn:
      - DeployFrontend
    Environment:
      Name: production
      Connections:
        - Name: aws-connection
          Role: CodeCatalystWorkflowDevelopmentRole-AWSCocha
    Inputs:
      Sources:
        - WorkflowSource
      Artifacts:
        - just-binary
        - prod-infrastructure-outputs
    Configuration:
      Commands:
        - echo "üß™ Running integration tests after deployment..."
        - echo "Project: $PROJECT_NAME | Timeout: $INTEGRATION_TEST_TIMEOUT seconds"
        - echo "Setting up environment..."
        - cp /usr/local/bin/just /usr/local/bin/just || true
        - chmod +x /usr/local/bin/just
        - export PATH="/usr/local/bin:$PATH"
        - echo "Restoring deployment outputs..."
        - cp deployment-outputs-prod.env $DEPLOYMENT_OUTPUTS_FILE
        - echo "Running integration tests..."
        - source $DEPLOYMENT_OUTPUTS_FILE
        - echo "Testing API health endpoint..."
        - timeout $HEALTH_CHECK_TIMEOUT curl -f "$API_URL/health" || exit 1
        - echo "Testing API people endpoint..."
        - timeout $HEALTH_CHECK_TIMEOUT curl -f "$API_URL/people" || exit 1
        - echo "Testing frontend accessibility..."
        - timeout $HEALTH_CHECK_TIMEOUT curl -f -I "$FRONTEND_URL" || exit 1
        - echo "Verifying test data..."
        - PEOPLE_COUNT=$(curl -s "$API_URL/people" | jq length)
        - echo "People count: $PEOPLE_COUNT"
        - if [ "$PEOPLE_COUNT" -lt 1 ]; then echo "No people found, test failed"; exit 1; fi
        - echo "‚úÖ All integration tests passed!"
    # CRITICAL: Only run on main branch pushes (after merge approval)
    Condition:
      StringEquals:
        - "${WorkflowSource.BranchName}"
        - "main"

  # Notification of successful deployment (ONLY on main branch push after merge)
  NotifyDeploymentSuccess:
    Identifier: aws/build@v1
    DependsOn:
      - IntegrationTests
    Inputs:
      Sources:
        - WorkflowSource
      Artifacts:
        - just-binary
        - prod-infrastructure-outputs
    Configuration:
      Commands:
        - echo "üì¢ Deployment Notification"
        - echo "=========================="
        - echo "‚úÖ Production deployment completed successfully!"
        - echo "üîó Project: $PROJECT_NAME"
        - echo "üèóÔ∏è  Stack: $STACK_NAME"
        - echo "üåç Region: $AWS_REGION"
        - echo "üîß Environment: $ENVIRONMENT"
        - echo "üìÖ Deployment time: $(date)"
        - echo "üè∑Ô∏è  Commit: ${WorkflowSource.CommitId}"
        - echo "üë§ Author: ${WorkflowSource.CommitAuthor}"
        - source deployment-outputs-prod.env
        - echo "üåê Frontend URL: $FRONTEND_URL"
        - echo "üîß API URL: $API_URL"
        - echo "üìä All systems operational"
        - echo "=========================="
    # CRITICAL: Only run on main branch pushes (after merge approval)
    Condition:
      StringEquals:
        - "${WorkflowSource.BranchName}"
        - "main"
