Name: Deploy-Infrastructure
SchemaVersion: "1.0"

Triggers:
  - Type: PUSH
    Branches:
      - main
  - Type: PULLREQUEST
    Branches:
      - main
    Events:
      - OPEN
      - REVISION

Actions:
  InstallJust:
    Identifier: aws/build@v1
    Inputs:
      Sources:
        - WorkflowSource
    Configuration:
      Steps:
        - Run: |
            echo "Installing just command runner..."
            curl --proto "=https" --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin
            just --version
            echo "‚úÖ just installed successfully"
    Outputs:
      Artifacts:
        - Name: just-binary
          Files:
            - "/usr/local/bin/just"

  ValidateInfrastructure:
    Identifier: aws/build@v1
    DependsOn:
      - InstallJust
    Inputs:
      Sources:
        - WorkflowSource
      Artifacts:
        - just-binary
    Configuration:
      Steps:
        - Run: |
            echo "Setting up environment..."
            cp /usr/local/bin/just /usr/local/bin/just || true
            chmod +x /usr/local/bin/just
            export PATH="/usr/local/bin:$PATH"
            export PROJECT_NAME="people-registry"
            export STACK_NAME="PeopleRegisterInfrastructureStack"
            export AWS_REGION="us-east-1"
            export ENVIRONMENT="production"
            export APPLICATION_NAME="People-Register"
            export APPLICATION_VERSION="1.0.0"
            export ORGANIZATION="AWSCocha"
            export LAMBDA_RUNTIME="python3.11"
            export LAMBDA_MEMORY="256"
            export DYNAMODB_BILLING_MODE="PAY_PER_REQUEST"
            echo "üîç Validating infrastructure for $APPLICATION_NAME ($PROJECT_NAME)"
            echo "Stack: $STACK_NAME | Region: $AWS_REGION | Environment: $ENVIRONMENT"
            echo "Version: $APPLICATION_VERSION | Organization: $ORGANIZATION"
            echo "DynamoDB: $DYNAMODB_BILLING_MODE | Lambda: $LAMBDA_RUNTIME ($LAMBDA_MEMORY MB)"
            echo "Checking prerequisites..."
            just check-prerequisites
            echo "Running CDK synth to validate..."
            just cdk-synth
            echo "Running unit tests..."
            source .venv/bin/activate && python -m pytest tests/ -v || echo "No tests found"
            echo "‚úÖ Infrastructure validation completed"

  DeployProduction:
    Identifier: aws/build@v1
    DependsOn:
      - ValidateInfrastructure
    Environment:
      Name: production_env
      Connections:
        - Name: "142728997126"
          Role: CodeCatalystWorkflowDevelopmentRole-AWSCocha
    Inputs:
      Sources:
        - WorkflowSource
      Artifacts:
        - just-binary
    Configuration:
      Steps:
        - Run: |
            # Only run on main branch
            if [ "${WorkflowSource.BranchName}" != "main" ]; then
              echo "Skipping deployment - not on main branch"
              exit 0
            fi
            
            echo "üöÄ Starting production deployment after merge to main..."
            export PROJECT_NAME="people-registry"
            export STACK_NAME="PeopleRegisterInfrastructureStack"
            export AWS_REGION="us-east-1"
            export ENVIRONMENT="production"
            export APPLICATION_NAME="People-Register"
            export APPLICATION_VERSION="1.0.0"
            export ORGANIZATION="AWSCocha"
            export COST_CENTER="UserGroup"
            export LAMBDA_RUNTIME="python3.11"
            export LAMBDA_MEMORY="256"
            export LAMBDA_TIMEOUT="30"
            export API_GATEWAY_NAME="PeopleRegisterAPI"
            export API_GATEWAY_STAGE="prod"
            export CDK_DEPLOY_TIMEOUT="1200"
            export TEST_DATA_COUNT="5"
            export OUTPUTS_FILE="outputs.json"
            export DEPLOYMENT_OUTPUTS_FILE="deployment-outputs.env"
            echo "Application: $APPLICATION_NAME v$APPLICATION_VERSION"
            echo "Project: $PROJECT_NAME | Stack: $STACK_NAME | Region: $AWS_REGION"
            echo "Organization: $ORGANIZATION | Cost Center: $COST_CENTER"
            echo "Lambda: $LAMBDA_RUNTIME ($LAMBDA_MEMORY MB, ${LAMBDA_TIMEOUT}s timeout)"
            echo "API Gateway: $API_GATEWAY_NAME ($API_GATEWAY_STAGE stage)"
            echo "Setting up environment..."
            cp /usr/local/bin/just /usr/local/bin/just || true
            chmod +x /usr/local/bin/just
            export PATH="/usr/local/bin:$PATH"
            echo "Deploying infrastructure to production..."
            timeout $CDK_DEPLOY_TIMEOUT just deploy-infrastructure-full
            echo "Testing API endpoints..."
            just test-api
            echo "Creating $TEST_DATA_COUNT test records..."
            just create-test-data
            echo "Saving deployment outputs..."
            cp $OUTPUTS_FILE deployment-outputs-prod.json
            cp $DEPLOYMENT_OUTPUTS_FILE deployment-outputs-prod.env
            echo "Printing deployment summary..."
            just print-deployment-summary
            echo "‚úÖ Production infrastructure deployment completed"
    Outputs:
      Artifacts:
        - Name: prod-infrastructure-outputs
          Files:
            - deployment-outputs-prod.json
            - deployment-outputs-prod.env

  DeployFrontend:
    Identifier: aws/build@v1
    DependsOn:
      - DeployProduction
    Environment:
      Name: production_env
      Connections:
        - Name: "142728997126"
          Role: CodeCatalystWorkflowDevelopmentRole-AWSCocha
    Inputs:
      Sources:
        - WorkflowSource
      Artifacts:
        - just-binary
        - prod-infrastructure-outputs
    Configuration:
      Steps:
        - Run: |
            # Only run on main branch
            if [ "${WorkflowSource.BranchName}" != "main" ]; then
              echo "Skipping frontend deployment - not on main branch"
              exit 0
            fi
            
            echo "üé® Starting frontend deployment after infrastructure..."
            export PROJECT_NAME="people-registry"
            export ENVIRONMENT="production"
            export DEPLOYMENT_OUTPUTS_FILE="deployment-outputs.env"
            echo "Project: $PROJECT_NAME | Environment: $ENVIRONMENT"
            echo "Setting up environment..."
            cp /usr/local/bin/just /usr/local/bin/just || true
            chmod +x /usr/local/bin/just
            export PATH="/usr/local/bin:$PATH"
            echo "Restoring deployment outputs..."
            cp deployment-outputs-prod.env $DEPLOYMENT_OUTPUTS_FILE
            echo "Deploying frontend..."
            just deploy-frontend-full
            echo "Testing frontend..."
            just test-frontend
            echo "Validating complete deployment..."
            just validate-deployment
            echo "Final deployment summary..."
            just print-deployment-summary
            echo "‚úÖ Frontend deployment completed"

  IntegrationTests:
    Identifier: aws/build@v1
    DependsOn:
      - DeployFrontend
    Environment:
      Name: production_env
      Connections:
        - Name: "142728997126"
          Role: CodeCatalystWorkflowDevelopmentRole-AWSCocha
    Inputs:
      Sources:
        - WorkflowSource
      Artifacts:
        - just-binary
        - prod-infrastructure-outputs
    Configuration:
      Steps:
        - Run: |
            # Only run on main branch
            if [ "${WorkflowSource.BranchName}" != "main" ]; then
              echo "Skipping integration tests - not on main branch"
              exit 0
            fi
            
            echo "üß™ Running integration tests after deployment..."
            export PROJECT_NAME="people-registry"
            export INTEGRATION_TEST_TIMEOUT="60"
            export HEALTH_CHECK_TIMEOUT="30"
            export DEPLOYMENT_OUTPUTS_FILE="deployment-outputs.env"
            echo "Project: $PROJECT_NAME | Timeout: $INTEGRATION_TEST_TIMEOUT seconds"
            echo "Setting up environment..."
            cp /usr/local/bin/just /usr/local/bin/just || true
            chmod +x /usr/local/bin/just
            export PATH="/usr/local/bin:$PATH"
            echo "Restoring deployment outputs..."
            cp deployment-outputs-prod.env $DEPLOYMENT_OUTPUTS_FILE
            echo "Running integration tests..."
            source $DEPLOYMENT_OUTPUTS_FILE
            echo "Testing API health endpoint..."
            timeout $HEALTH_CHECK_TIMEOUT curl -f "$API_URL/health" || exit 1
            echo "Testing API people endpoint..."
            timeout $HEALTH_CHECK_TIMEOUT curl -f "$API_URL/people" || exit 1
            echo "Testing frontend accessibility..."
            timeout $HEALTH_CHECK_TIMEOUT curl -f -I "$FRONTEND_URL" || exit 1
            echo "Verifying test data..."
            PEOPLE_COUNT=$(curl -s "$API_URL/people" | jq length)
            echo "People count: $PEOPLE_COUNT"
            if [ "$PEOPLE_COUNT" -lt 1 ]; then echo "No people found, test failed"; exit 1; fi
            echo "‚úÖ All integration tests passed!"

  NotifyDeploymentSuccess:
    Identifier: aws/build@v1
    DependsOn:
      - IntegrationTests
    Inputs:
      Sources:
        - WorkflowSource
      Artifacts:
        - just-binary
        - prod-infrastructure-outputs
    Configuration:
      Steps:
        - Run: |
            # Only run on main branch
            if [ "${WorkflowSource.BranchName}" != "main" ]; then
              echo "Skipping notification - not on main branch"
              exit 0
            fi
            
            echo "üì¢ Deployment Notification"
            echo "=========================="
            echo "‚úÖ Production deployment completed successfully!"
            export PROJECT_NAME="people-registry"
            export STACK_NAME="PeopleRegisterInfrastructureStack"
            export AWS_REGION="us-east-1"
            export ENVIRONMENT="production"
            echo "üîó Project: $PROJECT_NAME"
            echo "üèóÔ∏è  Stack: $STACK_NAME"
            echo "üåç Region: $AWS_REGION"
            echo "üîß Environment: $ENVIRONMENT"
            echo "üìÖ Deployment time: $(date)"
            echo "üè∑Ô∏è  Commit: ${WorkflowSource.CommitId}"
            echo "üë§ Author: ${WorkflowSource.CommitAuthor}"
            source deployment-outputs-prod.env
            echo "üåê Frontend URL: $FRONTEND_URL"
            echo "üîß API URL: $API_URL"
            echo "üìä All systems operational"
            echo "=========================="
