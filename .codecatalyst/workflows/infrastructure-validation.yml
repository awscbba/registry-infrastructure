Name: Infrastructure_Validation_Pipeline
SchemaVersion: "1.0"

Triggers:
  - Type: PUSH
    # Run on all branch pushes, handle main branch exclusion in script logic
  - Type: PULLREQUEST
    Branches:
      - main
    Events:
      - OPEN
      - REVISION

Actions:
  ValidateInfrastructure:
    Identifier: aws/build@v1
    Compute:
      Type: EC2
    Environment:
      Connections:
        - Role: CodeCatalystWorkflowDevelopmentRole-AWSCocha
          Name: "142728997126"
      Name: AWS
    Inputs:
      Sources:
        - WorkflowSource
    Configuration:
      Steps:
        - Run: |
            echo "‚ö° Infrastructure Validation"
            echo "=========================="
            echo "üìÖ Stage Start: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo ""

            # Set execution mode for validation workflow
            BRANCH_NAME="${CODECATALYST_SOURCE_BRANCH_NAME:-unknown}"
            TRIGGER_TYPE="${CODECATALYST_TRIGGER_TYPE:-PUSH}"

            # Skip execution if this is a main branch push (deployment workflow handles it)
            if [ "$TRIGGER_TYPE" = "PUSH" ] && [ "$BRANCH_NAME" = "main" ]; then
                echo "‚è≠Ô∏è Skipping validation workflow for main branch push"
                echo "üìã Main branch pushes are handled by the deployment workflow"
                echo "‚úÖ Validation workflow completed (skipped for main branch)"
                exit 0
            fi

            EXECUTION_MODE="validation"
            if [ "$TRIGGER_TYPE" = "PULLREQUEST" ]; then
                echo "üéØ Mode: validation (PR to main)"
            else
                echo "üéØ Mode: validation (feature branch push: $BRANCH_NAME)"
            fi
            echo ""

            # CDK Synthesis Check with Node.js warning handling
            echo "üîÑ CDK Synthesis Check..."

            # Install Node 20 using NVM (more reliable)
            echo "Installing Node 20 using NVM..."
            
            # Install NVM
            curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
            
            # Load NVM
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
            
            # Install and use Node 20
            nvm install 20
            nvm use 20
            
            # Verify Node version
            echo "Node version: $(node --version)"
            echo "NPM version: $(npm --version)"
            echo "Node path: $(which node)"
            
            # Install CDK with Node 20
            echo "Installing CDK..."
            npm install -g aws-cdk@latest
            
            # Setup Python environment
            python3 -m venv .venv > /dev/null 2>&1
            source .venv/bin/activate
            pip install -r requirements.txt > /dev/null 2>&1

            # Suppress Node.js end-of-life warnings for CDK
            export CDK_DISABLE_VERSION_CHECK=1
            export NODE_NO_WARNINGS=1
            export NODE_OPTIONS="--no-warnings"

            # Run CDK synthesis with intelligent error handling
            echo "Running CDK synthesis..."
            set +e  # Don't exit on error immediately
            cdk synth > cdk-synth-output.txt 2>cdk-synth-errors.txt
            CDK_EXIT_CODE=$?
            set -e  # Re-enable exit on error

            # Check if the failure is just due to Node.js warnings
            if [ $CDK_EXIT_CODE -eq 0 ]; then
                echo "‚úÖ CDK synthesis successful - Infrastructure is valid"
                VALIDATION_STATUS="success"
            elif grep -q "Node.*has reached end-of-life" cdk-synth-errors.txt; then
                echo "‚ö†Ô∏è Node.js end-of-life warning detected - checking if synthesis actually succeeded..."
                
                # Check if CDK actually generated templates despite the warning
                if ls cdk.out/*.template.json >/dev/null 2>&1 || ls cdk.out/*.template.yaml >/dev/null 2>&1; then
                    echo "‚úÖ CDK synthesis succeeded despite Node.js warnings (CloudFormation templates found)"
                    echo "üìã Node.js warning is informational only - infrastructure is valid"
                    VALIDATION_STATUS="success"
                else
                    echo "‚ùå CDK synthesis failed - no CloudFormation templates generated"
                    VALIDATION_STATUS="failed"
                fi
            else
                echo "‚ùå CDK synthesis failed - Infrastructure has real errors"
                VALIDATION_STATUS="failed"
            fi

            # Create artifacts based on validation status
            if [ "$VALIDATION_STATUS" = "success" ]; then
                echo '{"status":"success","execution_mode":"'$EXECUTION_MODE'"}' > validation-results.json
                echo "CDK Synthesis: SUCCESS" > validation-report.txt
                echo "‚úÖ Infrastructure validation completed successfully"
                echo "üìã This was a validation-only run - no deployment performed"
            else
                echo '{"status":"failed","execution_mode":"'$EXECUTION_MODE'"}' > validation-results.json
                echo "CDK Synthesis: FAILED" > validation-report.txt
                echo ""
                echo "Error details:"
                head -20 cdk-synth-errors.txt
                exit 1
            fi

            echo ""
            echo "üìä Stage: ValidateInfrastructure - COMPLETED"
            echo "‚è±Ô∏è Duration: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
      Container:
        Registry: CODECATALYST
        Image: CodeCatalystLinux_x86_64:2024_03
    Outputs:
      Artifacts:
        - Name: validationResults
          Files:
            - "validation-results.json"
            - "validation-report.txt"
            - "cdk-synth-output.txt"
            - "cdk-synth-errors.txt"
