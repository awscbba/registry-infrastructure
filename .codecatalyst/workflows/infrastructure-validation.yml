Name: Infrastructure_Validation_Pipeline
SchemaVersion: "1.0"

Triggers:
  - Type: PUSH
    # Run on feature branches for fast feedback during development
    # Try pattern without quotes
    Branches:
      - feature/*
  - Type: PULLREQUEST
    Branches:
      - main
    Events:
      - OPEN
      - REVISION

Actions:
  CheckAPISync:
    Identifier: aws/build@v1
    Compute:
      Type: EC2
    Environment:
      Connections:
        - Role: CodeCatalystWorkflowDevelopmentRole-AWSCocha
          Name: "142728997126"
      Name: AWS
    Inputs:
      Sources:
        - WorkflowSource
    Configuration:
      Steps:
        - Run: |
            echo "üîç Checking API Code Synchronization"
            echo "==================================="
            echo "üìÖ Stage Start: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo ""

            # Set execution mode - always validation for this workflow
            BRANCH_NAME="${CODECATALYST_SOURCE_BRANCH_NAME:-unknown}"
            TRIGGER_TYPE="${CODECATALYST_TRIGGER_TYPE:-PUSH}"

            export EXECUTION_MODE="validation"
            export SKIP_DEPLOYMENT="true"

            if [ "$TRIGGER_TYPE" = "PULLREQUEST" ]; then
                echo "üéØ Mode: validation (PR to main)"
            else
                echo "üéØ Mode: validation (feature branch push: $BRANCH_NAME)"
                echo "üìã Note: Main branch pushes use the deployment workflow instead"
            fi

            # Check for API sync
            if [ -f "lambda/main.py" ] && [ -d "lambda/src" ]; then
                echo "‚úÖ API code synchronized from registry-api repository"
                API_SYNC_DETECTED="true"
            else
                echo "‚ÑπÔ∏è No API sync detected - using existing lambda handlers"
                API_SYNC_DETECTED="false"
            fi

            # Create deployment context
            echo "{" > deployment-context.json
            echo "  \"execution_mode\": \"$EXECUTION_MODE\"," >> deployment-context.json
            echo "  \"api_sync_detected\": \"$API_SYNC_DETECTED\"," >> deployment-context.json
            echo "  \"skip_deployment\": \"$SKIP_DEPLOYMENT\"," >> deployment-context.json
            echo "  \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"" >> deployment-context.json
            echo "}" >> deployment-context.json

            echo "‚úÖ API sync check completed"
      Container:
        Registry: CODECATALYST
        Image: CodeCatalystLinux_x86_64:2024_03
    Outputs:
      Artifacts:
        - Name: deploymentContext
          Files:
            - "deployment-context.json"

  ValidateInfrastructure:
    Identifier: aws/build@v1
    DependsOn:
      - CheckAPISync
    Compute:
      Type: EC2
    Environment:
      Connections:
        - Role: CodeCatalystWorkflowDevelopmentRole-AWSCocha
          Name: "142728997126"
      Name: AWS
    Inputs:
      Sources:
        - WorkflowSource
      Artifacts:
        - deploymentContext
    Configuration:
      Steps:
        - Run: |
            echo "‚ö° Infrastructure Validation"
            echo "=========================="
            echo "üìÖ Stage Start: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo ""

            # Read execution mode from context
            EXECUTION_MODE=$(jq -r '.execution_mode' deployment-context.json)
            echo "üéØ Mode: $EXECUTION_MODE"
            echo ""

            # CDK Synthesis Check with Node.js warning handling
            echo "üîÑ CDK Synthesis Check..."

            # Install CDK and dependencies (use older version that supports Node 18)
            npm install -g aws-cdk@2.60.0 > /dev/null 2>&1
            python3 -m venv .venv > /dev/null 2>&1
            source .venv/bin/activate
            pip install -r requirements.txt > /dev/null 2>&1

            # Suppress Node.js end-of-life warnings for CDK
            export CDK_DISABLE_VERSION_CHECK=1
            export NODE_NO_WARNINGS=1

            # Run CDK synthesis with intelligent error handling
            echo "Running CDK synthesis..."
            cdk synth > cdk-synth-output.txt 2>cdk-synth-errors.txt
            CDK_EXIT_CODE=$?

            # Check if the failure is just due to Node.js warnings
            if [ $CDK_EXIT_CODE -eq 0 ]; then
                echo "‚úÖ CDK synthesis successful - Infrastructure is valid"
                VALIDATION_STATUS="success"
            elif grep -q "Node.*has reached end-of-life" cdk-synth-errors.txt; then
                echo "‚ö†Ô∏è Node.js end-of-life warning detected - checking if synthesis actually succeeded..."
                
                # Check if CDK actually generated templates despite the warning
                if ls cdk.out/*.template.json >/dev/null 2>&1 || ls cdk.out/*.template.yaml >/dev/null 2>&1; then
                    echo "‚úÖ CDK synthesis succeeded despite Node.js warnings (CloudFormation templates found)"
                    echo "üìã Node.js warning is informational only - infrastructure is valid"
                    VALIDATION_STATUS="success"
                else
                    echo "‚ùå CDK synthesis failed - no CloudFormation templates generated"
                    VALIDATION_STATUS="failed"
                fi
            else
                echo "‚ùå CDK synthesis failed - Infrastructure has real errors"
                VALIDATION_STATUS="failed"
            fi

            # Create artifacts based on validation status
            if [ "$VALIDATION_STATUS" = "success" ]; then
                echo '{"status":"success","execution_mode":"'$EXECUTION_MODE'"}' > validation-results.json
                echo "CDK Synthesis: SUCCESS" > validation-report.txt
                echo "‚úÖ Infrastructure validation completed successfully"
                echo "üìã This was a validation-only run - no deployment performed"
            else
                echo '{"status":"failed","execution_mode":"'$EXECUTION_MODE'"}' > validation-results.json
                echo "CDK Synthesis: FAILED" > validation-report.txt
                echo ""
                echo "Error details:"
                head -20 cdk-synth-errors.txt
                exit 1
            fi

            echo ""
            echo "üìä Stage: ValidateInfrastructure - COMPLETED"
            echo "‚è±Ô∏è Duration: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
      Container:
        Registry: CODECATALYST
        Image: CodeCatalystLinux_x86_64:2024_03
    Outputs:
      Artifacts:
        - Name: validationResults
          Files:
            - "validation-results.json"
            - "validation-report.txt"
            - "cdk-synth-output.txt"
            - "cdk-synth-errors.txt"
