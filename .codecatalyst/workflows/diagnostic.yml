Name: Diagnostic_Pipeline
SchemaVersion: "1.0"

Triggers:
  - Type: PUSH
    Branches:
      - main

Actions:
  DiagnosticRun:
    Identifier: aws/build@v1
    Inputs:
      Sources:
        - WorkflowSource
    Configuration:
      Steps:
        - Run: |
            set -e  # Exit on any error
            
            echo "üîç DIAGNOSTIC PIPELINE - Detailed Error Tracking"
            echo "================================================"
            
            # Function to log errors
            log_error() {
                echo "‚ùå ERROR at step: $1"
                echo "Error details: $2"
                echo "Exit code: $3"
                echo "Timestamp: $(date)"
                echo "----------------------------------------"
            }
            
            # Function to log success
            log_success() {
                echo "‚úÖ SUCCESS: $1"
            }
            
            # Step 1: Environment check
            echo "Step 1: Environment Check"
            whoami || log_error "whoami" "$?" "$?"
            pwd || log_error "pwd" "$?" "$?"
            echo "PATH: $PATH"
            log_success "Environment check"
            
            # Step 2: Install just
            echo "Step 2: Installing just"
            if curl --proto "=https" --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin; then
                log_success "just installation"
            else
                log_error "just installation" "curl failed" "$?"
                exit 1
            fi
            
            # Step 3: Verify just
            echo "Step 3: Verify just installation"
            if /usr/local/bin/just --version; then
                log_success "just verification"
            else
                log_error "just verification" "just --version failed" "$?"
                exit 1
            fi
            
            # Step 4: Python check
            echo "Step 4: Python environment"
            if python3 --version; then
                log_success "Python check"
            else
                log_error "Python check" "python3 not available" "$?"
                exit 1
            fi
            
            # Step 5: Node check
            echo "Step 5: Node environment"
            if node --version; then
                log_success "Node check"
            else
                log_error "Node check" "node not available" "$?"
                exit 1
            fi
            
            # Step 6: Virtual environment
            echo "Step 6: Python virtual environment"
            if python3 -m venv .venv; then
                log_success "Virtual environment creation"
            else
                log_error "Virtual environment" "venv creation failed" "$?"
                exit 1
            fi
            
            # Step 7: Activate venv and install deps
            echo "Step 7: Install Python dependencies"
            if source .venv/bin/activate && pip install -r requirements.txt; then
                log_success "Python dependencies"
            else
                log_error "Python dependencies" "pip install failed" "$?"
                exit 1
            fi
            
            # Step 8: Install CDK
            echo "Step 8: Install CDK"
            if npm install -g aws-cdk; then
                log_success "CDK installation"
            else
                log_error "CDK installation" "npm install failed" "$?"
                exit 1
            fi
            
            # Step 9: CDK version check
            echo "Step 9: CDK version check"
            if cdk --version; then
                log_success "CDK version check"
            else
                log_error "CDK version" "cdk --version failed" "$?"
                exit 1
            fi
            
            # Step 10: CDK synth
            echo "Step 10: CDK synth"
            if source .venv/bin/activate && cdk synth --quiet; then
                log_success "CDK synth"
            else
                log_error "CDK synth" "cdk synth failed" "$?"
                exit 1
            fi
            
            # Step 11: Just commands check
            echo "Step 11: Just commands availability"
            if /usr/local/bin/just --list | head -5; then
                log_success "Just commands list"
            else
                log_error "Just commands" "just --list failed" "$?"
                exit 1
            fi
            
            echo "üéâ ALL DIAGNOSTIC STEPS PASSED"
            echo "The issue might be in the deployment phase or AWS permissions"
