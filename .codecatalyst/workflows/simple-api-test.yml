Name: Simple_API_Test
SchemaVersion: "1.0"

Triggers:
  - Type: PUSH
    Branches:
      - main

Actions:
  TestAPI:
    Identifier: aws/build@v1
    Inputs:
      Sources:
        - WorkflowSource
    Configuration:
      Steps:
        - Run: |
            set +e
            
            echo "üß™ Simple API Testing (Using Known Deployment)"
            echo "Branch: ${CODECATALYST_SOURCE_BRANCH_NAME}"
            echo "Commit: ${CODECATALYST_SOURCE_BRANCH_REF}"
            
            OVERALL_SUCCESS=true
            
            # Since we know the infrastructure was deployed successfully,
            # let's try to get the outputs using the justfile commands
            
            # Install just
            echo "üîÑ Installing just..."
            curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin
            
            # Check if we have outputs from previous deployment
            echo "üîç Checking for deployment outputs..."
            
            # Try to get stack outputs using AWS CLI
            echo "Attempting to get CloudFormation outputs..."
            if aws cloudformation describe-stacks \
              --stack-name PeopleRegisterInfrastructureStack \
              --region us-west-2 \
              --query 'Stacks[0].Outputs' > stack-outputs.json 2>/dev/null; then
              
              echo "‚úÖ Successfully retrieved stack outputs"
              cat stack-outputs.json
              
              # Extract key values
              API_URL=$(cat stack-outputs.json | jq -r '.[] | select(.OutputKey=="ApiUrl") | .OutputValue')
              FRONTEND_URL=$(cat stack-outputs.json | jq -r '.[] | select(.OutputKey=="FrontendUrl") | .OutputValue')
              S3_BUCKET=$(cat stack-outputs.json | jq -r '.[] | select(.OutputKey=="S3BucketName") | .OutputValue')
              
              echo "üìä DEPLOYMENT INFORMATION:"
              echo "API URL: $API_URL"
              echo "Frontend URL: $FRONTEND_URL"
              echo "S3 Bucket: $S3_BUCKET"
              
              # Test API endpoints
              echo "üß™ Testing API endpoints..."
              
              # Health check
              echo "Testing health endpoint..."
              HEALTH_RESPONSE=$(curl -s -w "HTTP_CODE:%{http_code}" "$API_URL/health")
              HTTP_CODE=$(echo "$HEALTH_RESPONSE" | grep -o "HTTP_CODE:[0-9]*" | cut -d: -f2)
              HEALTH_BODY=$(echo "$HEALTH_RESPONSE" | sed 's/HTTP_CODE:[0-9]*$//')
              
              if [ "$HTTP_CODE" = "200" ]; then
                echo "‚úÖ Health check passed (HTTP $HTTP_CODE)"
                echo "Response: $HEALTH_BODY"
              else
                echo "‚ùå Health check failed (HTTP $HTTP_CODE)"
                echo "Response: $HEALTH_BODY"
                OVERALL_SUCCESS=false
              fi
              
              # Test people endpoint
              echo "Testing people endpoint..."
              PEOPLE_RESPONSE=$(curl -s -w "HTTP_CODE:%{http_code}" "$API_URL/people")
              HTTP_CODE=$(echo "$PEOPLE_RESPONSE" | grep -o "HTTP_CODE:[0-9]*" | cut -d: -f2)
              PEOPLE_BODY=$(echo "$PEOPLE_RESPONSE" | sed 's/HTTP_CODE:[0-9]*$//')
              
              if [ "$HTTP_CODE" = "200" ]; then
                echo "‚úÖ People endpoint accessible (HTTP $HTTP_CODE)"
                echo "Response: $PEOPLE_BODY"
              else
                echo "‚ùå People endpoint failed (HTTP $HTTP_CODE)"
                echo "Response: $PEOPLE_BODY"
                OVERALL_SUCCESS=false
              fi
              
              # Create test person
              echo "Creating test person..."
              TEST_RESPONSE=$(curl -s -w "HTTP_CODE:%{http_code}" -X POST "$API_URL/people" \
                -H "Content-Type: application/json" \
                -d '{
                  "firstName": "Test",
                  "lastName": "User",
                  "email": "test@example.com",
                  "phone": "+1-555-0123",
                  "dateOfBirth": "1990-01-01",
                  "address": {
                    "street": "123 Test St",
                    "city": "Test City",
                    "state": "TS",
                    "zipCode": "12345",
                    "country": "USA"
                  }
                }')
              
              HTTP_CODE=$(echo "$TEST_RESPONSE" | grep -o "HTTP_CODE:[0-9]*" | cut -d: -f2)
              TEST_BODY=$(echo "$TEST_RESPONSE" | sed 's/HTTP_CODE:[0-9]*$//')
              
              if [ "$HTTP_CODE" = "201" ]; then
                echo "‚úÖ Successfully created test person (HTTP $HTTP_CODE)"
                echo "Response: $TEST_BODY"
                
                # Try to extract person ID and test GET
                if echo "$TEST_BODY" | jq -e '.id' > /dev/null 2>&1; then
                  PERSON_ID=$(echo "$TEST_BODY" | jq -r '.id')
                  echo "Testing GET person by ID: $PERSON_ID"
                  
                  GET_RESPONSE=$(curl -s -w "HTTP_CODE:%{http_code}" "$API_URL/people/$PERSON_ID")
                  HTTP_CODE=$(echo "$GET_RESPONSE" | grep -o "HTTP_CODE:[0-9]*" | cut -d: -f2)
                  GET_BODY=$(echo "$GET_RESPONSE" | sed 's/HTTP_CODE:[0-9]*$//')
                  
                  if [ "$HTTP_CODE" = "200" ]; then
                    echo "‚úÖ GET person by ID works (HTTP $HTTP_CODE)"
                    echo "Response: $GET_BODY"
                  else
                    echo "‚ùå GET person by ID failed (HTTP $HTTP_CODE)"
                    echo "Response: $GET_BODY"
                  fi
                fi
                
              else
                echo "‚ùå Failed to create test person (HTTP $HTTP_CODE)"
                echo "Response: $TEST_BODY"
                OVERALL_SUCCESS=false
              fi
              
            else
              echo "‚ùå Could not retrieve stack outputs"
              echo "This might be due to:"
              echo "1. AWS credentials not configured in this workflow"
              echo "2. Stack not deployed yet"
              echo "3. Different stack name or region"
              
              # Try to use justfile commands as fallback
              echo "üîÑ Trying justfile commands as fallback..."
              if [ -f "justfile" ]; then
                /usr/local/bin/just extract-outputs || echo "‚ö†Ô∏è Justfile extract-outputs failed"
                /usr/local/bin/just test-api || echo "‚ö†Ô∏è Justfile test-api failed"
              else
                echo "‚ö†Ô∏è No justfile found"
              fi
              
              OVERALL_SUCCESS=false
            fi
            
            # Final summary
            echo "üìä API TESTING SUMMARY"
            echo "======================"
            if [ "$OVERALL_SUCCESS" = true ]; then
              echo "üéâ All API tests passed!"
              echo "‚úÖ Health endpoint working"
              echo "‚úÖ People CRUD operations working"
              echo "‚úÖ API is fully functional"
              echo ""
              echo "üåê Your API is ready at: $API_URL"
              echo "üé® Frontend URL: $FRONTEND_URL"
              echo ""
              echo "üí° Next steps:"
              echo "1. Deploy frontend to S3 bucket: $S3_BUCKET"
              echo "2. Configure frontend with API URL: $API_URL"
              echo "3. Test the complete application"
              exit 0
            else
              echo "‚ùå Some API tests failed"
              echo "üîç Check the error messages above for details"
              echo ""
              echo "üí° If the infrastructure was deployed successfully,"
              echo "   the issue might be with AWS credentials in this workflow"
              exit 1
            fi
    Compute:
      Type: EC2
