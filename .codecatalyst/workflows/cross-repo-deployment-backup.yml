Name: Cross-Repository Deployment Coordination
SchemaVersion: "1.0"

# This workflow can be triggered manually or by other repositories
Triggers:
  - Type: MANUAL
  # Also trigger on pushes to main (for direct infrastructure changes)
  - Type: PUSH
    Branches:
      - main

Actions:
  # Determine deployment source
  DeploymentSourceCheck:
    Identifier: aws/build@v1
    Inputs:
      Sources:
        - WorkflowSource
    Environment:
      Variables:
        STACK_NAME: "PeopleRegisterInfrastructureStack"
        AWS_REGION: "us-west-2"
        ENVIRONMENT: "production"
    Configuration:
      Commands:
        - echo "ðŸ” Cross-Repository Deployment Coordination"
        - echo "==========================================="
        - echo "ðŸ“… Time: $(date)"
        - echo "ðŸ·ï¸  Commit: ${WorkflowSource.CommitId}"
        - echo "ðŸ‘¤ Author: ${WorkflowSource.CommitAuthor}"
        - echo "ðŸŒ¿ Branch: ${WorkflowSource.BranchName}"
        - echo "ðŸŽ¯ Trigger Type: ${WorkflowSource.SourceType}"
        - echo "ðŸ—ï¸  Stack Name: ${STACK_NAME}"
        - echo "ðŸŒ AWS Region: ${AWS_REGION}"
        - echo "ðŸ”§ Environment: ${ENVIRONMENT}"
        - echo ""
        - echo "ðŸ“‹ Deployment Context:"
        - if [ "${WorkflowSource.SourceType}" = "MANUAL" ]; then
            echo "  ðŸ”§ Triggered manually or by external repository";
            echo "  ðŸ“¦ Source: Cross-repository coordination";
          else
            echo "  ðŸ“¦ Source: Direct infrastructure repository change";
          fi
        - echo ""
        - echo "ðŸš€ Proceeding with infrastructure deployment..."

  # Install just command runner
  InstallJust:
    Identifier: aws/build@v1
    DependsOn:
      - DeploymentSourceCheck
    Inputs:
      Sources:
        - WorkflowSource
    Configuration:
      Commands:
        - echo "ðŸ“¦ Installing just command runner..."
        - curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin
        - chmod +x /usr/local/bin/just
        - just --version
        - echo "âœ… just installed successfully"
    Outputs:
      Artifacts:
        - Name: just-binary
          Files:
            - "/usr/local/bin/just"

  # Pre-deployment validation
  PreDeploymentValidation:
    Identifier: aws/build@v1
    DependsOn:
      - InstallJust
    Inputs:
      Sources:
        - WorkflowSource
      Artifacts:
        - just-binary
    Configuration:
      Commands:
        - echo "ðŸ”¬ Pre-deployment validation..."
        - cp /usr/local/bin/just /usr/local/bin/just || true
        - chmod +x /usr/local/bin/just
        - export PATH="/usr/local/bin:$PATH"
        - echo "Checking prerequisites..."
        - just check-prerequisites
        - echo "Running CDK synth validation..."
        - just cdk-synth
        - echo "âœ… Pre-deployment validation passed"

  # Comprehensive deployment
  ComprehensiveDeployment:
    Identifier: aws/build@v1
    DependsOn:
      - PreDeploymentValidation
    Environment:
      Name: production
      Connections:
        - Name: aws-connection
          Role: CodeCatalystWorkflowDevelopmentRole-AWSCocha
    Inputs:
      Sources:
        - WorkflowSource
      Artifacts:
        - just-binary
    Configuration:
      Commands:
        - echo "ðŸš€ COMPREHENSIVE DEPLOYMENT STARTED"
        - echo "===================================="
        - echo "âš ï¸  Deploying to PRODUCTION environment"
        - echo "ðŸ”— Coordinated deployment across repositories"
        - echo ""
        - cp /usr/local/bin/just /usr/local/bin/just || true
        - chmod +x /usr/local/bin/just
        - export PATH="/usr/local/bin:$PATH"
        - echo "ðŸ—ï¸  Running comprehensive deployment..."
        - just deploy-all-comprehensive
        - echo "âœ… COMPREHENSIVE DEPLOYMENT COMPLETED"
    Outputs:
      Artifacts:
        - Name: comprehensive-deployment-outputs
          Files:
            - outputs.json
            - deployment-outputs.env

  # Post-deployment coordination
  PostDeploymentCoordination:
    Identifier: aws/build@v1
    DependsOn:
      - ComprehensiveDeployment
    Environment:
      Name: production
      Connections:
        - Name: aws-connection
          Role: CodeCatalystWorkflowDevelopmentRole-AWSCocha
    Inputs:
      Sources:
        - WorkflowSource
      Artifacts:
        - just-binary
        - comprehensive-deployment-outputs
    Configuration:
      Commands:
        - echo "ðŸ”„ Post-Deployment Coordination"
        - echo "==============================="
        - cp /usr/local/bin/just /usr/local/bin/just || true
        - chmod +x /usr/local/bin/just
        - export PATH="/usr/local/bin:$PATH"
        - cp deployment-outputs.env deployment-outputs.env
        - echo "ðŸ§ª Running comprehensive validation..."
        - just validate-deployment
        - echo "ðŸ“Š Generating deployment summary..."
        - just print-deployment-summary
        - echo ""
        - echo "ðŸ”” Notifying source repositories..."
        - source deployment-outputs.env
        - echo "âœ… Cross-repository deployment coordination completed"
        - echo ""
        - echo "ðŸ“‹ Final Status:"
        - echo "  ðŸ—ï¸  Infrastructure: âœ… Deployed"
        - echo "  ðŸ”§ API: âœ… Operational"
        - echo "  ðŸŽ¨ Frontend: âœ… Accessible"
        - echo "  ðŸ§ª Tests: âœ… Passed"
        - echo "  ðŸŒ URLs:"
        - echo "    â€¢ Frontend: $FRONTEND_URL"
        - echo "    â€¢ API: $API_URL"

  # Generate cross-repository deployment report
  GenerateCrossRepoReport:
    Identifier: aws/build@v1
    DependsOn:
      - PostDeploymentCoordination
    Inputs:
      Sources:
        - WorkflowSource
      Artifacts:
        - comprehensive-deployment-outputs
    Configuration:
      Commands:
        - echo "ðŸ“„ Generating cross-repository deployment report..."
        - source deployment-outputs.env
        - echo "# Cross-Repository Deployment Report" > cross-repo-deployment-report.md
        - echo "" >> cross-repo-deployment-report.md
        - echo "## Deployment Overview" >> cross-repo-deployment-report.md
        - echo "- **Deployment Date:** $(date)" >> cross-repo-deployment-report.md
        - echo "- **Coordination Type:** Cross-repository deployment" >> cross-repo-deployment-report.md
        - echo "- **Trigger:** ${WorkflowSource.SourceType}" >> cross-repo-deployment-report.md
        - echo "- **Infrastructure Commit:** ${WorkflowSource.CommitId}" >> cross-repo-deployment-report.md
        - echo "" >> cross-repo-deployment-report.md
        - echo "## Affected Repositories" >> cross-repo-deployment-report.md
        - echo "- ðŸ—ï¸  **people-register-infrastructure**: Core deployment" >> cross-repo-deployment-report.md
        - echo "- ðŸ”§ **people-register-api**: Backend services" >> cross-repo-deployment-report.md
        - echo "- ðŸŽ¨ **people-register-frontend**: User interface" >> cross-repo-deployment-report.md
        - echo "" >> cross-repo-deployment-report.md
        - echo "## Deployment Results" >> cross-repo-deployment-report.md
        - echo "- **Infrastructure Status:** âœ… SUCCESS" >> cross-repo-deployment-report.md
        - echo "- **API URL:** $API_URL" >> cross-repo-deployment-report.md
        - echo "- **Frontend URL:** $FRONTEND_URL" >> cross-repo-deployment-report.md
        - echo "- **Validation Status:** âœ… PASSED" >> cross-repo-deployment-report.md
        - echo "" >> cross-repo-deployment-report.md
        - echo "## Next Steps" >> cross-repo-deployment-report.md
        - echo "- Monitor application performance across all components" >> cross-repo-deployment-report.md
        - echo "- Verify integration between API and frontend" >> cross-repo-deployment-report.md
        - echo "- Check CloudWatch logs for any issues" >> cross-repo-deployment-report.md
        - echo "- Validate user workflows end-to-end" >> cross-repo-deployment-report.md
        - cat cross-repo-deployment-report.md
        - echo "ðŸ“„ Cross-repository deployment report generated"
    Outputs:
      Artifacts:
        - Name: cross-repo-report
          Files:
            - cross-repo-deployment-report.md
            - deployment-outputs.env
