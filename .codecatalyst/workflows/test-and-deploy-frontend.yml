Name: Test_API_and_Deploy_Frontend
SchemaVersion: "1.0"

Triggers:
  - Type: PUSH
    Branches:
      - main

Actions:
  TestAndDeploy:
    Identifier: aws/build@v1
    Inputs:
      Sources:
        - WorkflowSource
    Configuration:
      Steps:
        - Run: |
            set +e
            
            echo "üß™ Testing Deployed API and Setting Up Frontend"
            echo "Branch: ${CODECATALYST_SOURCE_BRANCH_NAME}"
            echo "Commit: ${CODECATALYST_SOURCE_BRANCH_REF}"
            
            OVERALL_SUCCESS=true
            
            run_step() {
              local step_name="$1"
              local command="$2"
              echo "üîÑ Running: $step_name"
              
              if eval "$command"; then
                echo "‚úÖ $step_name - SUCCESS"
                return 0
              else
                local exit_code=$?
                echo "‚ùå $step_name - FAILED (exit code: $exit_code)"
                OVERALL_SUCCESS=false
                return $exit_code
              fi
            }
            
            # Install just
            run_step "Install just" "curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin"
            
            # Get stack outputs
            echo "üîç Getting deployment information..."
            aws cloudformation describe-stacks \
              --stack-name PeopleRegisterInfrastructureStack \
              --region us-west-2 \
              --query 'Stacks[0].Outputs' > stack-outputs.json
            
            if [ $? -eq 0 ]; then
              echo "‚úÖ Successfully retrieved stack outputs"
              cat stack-outputs.json
              
              # Extract key values
              API_URL=$(cat stack-outputs.json | jq -r '.[] | select(.OutputKey=="ApiUrl") | .OutputValue')
              FRONTEND_URL=$(cat stack-outputs.json | jq -r '.[] | select(.OutputKey=="FrontendUrl") | .OutputValue')
              S3_BUCKET=$(cat stack-outputs.json | jq -r '.[] | select(.OutputKey=="S3BucketName") | .OutputValue')
              
              echo "üìä DEPLOYMENT INFORMATION:"
              echo "API URL: $API_URL"
              echo "Frontend URL: $FRONTEND_URL"
              echo "S3 Bucket: $S3_BUCKET"
              
              # Test API endpoints
              echo "üß™ Testing API endpoints..."
              
              # Health check
              echo "Testing health endpoint..."
              if curl -s -f "$API_URL/health"; then
                echo "‚úÖ Health check passed"
              else
                echo "‚ùå Health check failed"
                OVERALL_SUCCESS=false
              fi
              
              # Test people endpoint
              echo "Testing people endpoint..."
              if curl -s -f "$API_URL/people"; then
                echo "‚úÖ People endpoint accessible"
              else
                echo "‚ùå People endpoint failed"
                OVERALL_SUCCESS=false
              fi
              
              # Create test person
              echo "Creating test person..."
              TEST_RESPONSE=$(curl -s -X POST "$API_URL/people" \
                -H "Content-Type: application/json" \
                -d '{
                  "firstName": "Test",
                  "lastName": "User",
                  "email": "test@example.com",
                  "phone": "+1-555-0123",
                  "dateOfBirth": "1990-01-01",
                  "address": {
                    "street": "123 Test St",
                    "city": "Test City",
                    "state": "TS",
                    "zipCode": "12345",
                    "country": "USA"
                  }
                }')
              
              if echo "$TEST_RESPONSE" | jq -e '.id' > /dev/null; then
                echo "‚úÖ Successfully created test person"
                echo "Response: $TEST_RESPONSE"
                
                # Get the created person ID
                PERSON_ID=$(echo "$TEST_RESPONSE" | jq -r '.id')
                
                # Test GET person by ID
                echo "Testing GET person by ID..."
                if curl -s -f "$API_URL/people/$PERSON_ID"; then
                  echo "‚úÖ GET person by ID works"
                else
                  echo "‚ùå GET person by ID failed"
                fi
                
              else
                echo "‚ùå Failed to create test person"
                echo "Response: $TEST_RESPONSE"
                OVERALL_SUCCESS=false
              fi
              
              # Clone and deploy frontend if API tests pass
              if [ "$OVERALL_SUCCESS" = true ]; then
                echo "üé® Setting up frontend deployment..."
                
                # Clone frontend repository
                git clone https://git.us-west-2.codecatalyst.aws/v1/AWSCocha/people-registry/register-frontend.git frontend-repo || echo "Frontend repo clone failed, continuing..."
                
                if [ -d "frontend-repo" ]; then
                  cd frontend-repo
                  
                  # Install Node.js dependencies
                  if command -v npm >/dev/null 2>&1; then
                    echo "Installing frontend dependencies..."
                    npm install || echo "npm install failed, continuing..."
                    
                    # Create environment file with API URL
                    echo "PUBLIC_API_URL=$API_URL" > .env
                    echo "‚úÖ Created .env file with API URL"
                    
                    # Build frontend
                    echo "Building frontend..."
                    if npm run build; then
                      echo "‚úÖ Frontend build successful"
                      
                      # Deploy to S3
                      echo "Deploying to S3..."
                      if aws s3 sync dist/ "s3://$S3_BUCKET" --delete; then
                        echo "‚úÖ Frontend deployed to S3"
                        
                        # Get CloudFront distribution ID and invalidate cache
                        DISTRIBUTION_ID=$(aws cloudfront list-distributions \
                          --query "DistributionList.Items[?Origins.Items[0].DomainName=='$S3_BUCKET.s3.amazonaws.com'].Id" \
                          --output text)
                        
                        if [ -n "$DISTRIBUTION_ID" ] && [ "$DISTRIBUTION_ID" != "None" ]; then
                          echo "Invalidating CloudFront cache..."
                          aws cloudfront create-invalidation \
                            --distribution-id "$DISTRIBUTION_ID" \
                            --paths "/*" || echo "Cache invalidation failed, continuing..."
                        fi
                        
                      else
                        echo "‚ùå S3 deployment failed"
                        OVERALL_SUCCESS=false
                      fi
                    else
                      echo "‚ùå Frontend build failed"
                      OVERALL_SUCCESS=false
                    fi
                  else
                    echo "‚ö†Ô∏è npm not available, skipping frontend deployment"
                  fi
                  
                  cd ..
                else
                  echo "‚ö†Ô∏è Frontend repository not available, skipping frontend deployment"
                fi
              fi
              
            else
              echo "‚ùå Failed to get stack outputs"
              OVERALL_SUCCESS=false
            fi
            
            # Final summary
            echo "üìä TESTING AND DEPLOYMENT SUMMARY"
            echo "=================================="
            if [ "$OVERALL_SUCCESS" = true ]; then
              echo "üéâ All tests passed and frontend deployed!"
              echo "‚úÖ API is working correctly"
              echo "‚úÖ Frontend deployed to S3"
              echo "üåê Application URL: $FRONTEND_URL"
              echo "üîó API URL: $API_URL"
              exit 0
            else
              echo "‚ùå Some tests failed or deployment incomplete"
              echo "üîó API URL: $API_URL (if available)"
              exit 1
            fi
    Compute:
      Type: EC2
