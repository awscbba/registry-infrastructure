Name: Complete Application Deployment
SchemaVersion: "1.0"

# Only trigger on approved merges to main branch
Triggers:
  - Type: PUSH
    Branches:
      - main
  # Manual trigger for emergency deployments
  - Type: MANUAL

Actions:
  # Setup and validate environment
  Setup:
    Identifier: aws/build@v1
    Inputs:
      Sources:
        - WorkflowSource
    Configuration:
      Commands:
        - echo "ğŸš€ Starting People Register Application Deployment"
        - echo "=================================================="
        - echo "âš ï¸  PRODUCTION DEPLOYMENT TRIGGERED"
        - echo "ğŸ”— Trigger: Approved merge to main branch"
        - echo "ğŸ“… Time: $(date)"
        - echo "ğŸ·ï¸  Commit: ${WorkflowSource.CommitId}"
        - echo "ğŸ‘¤ Author: ${WorkflowSource.CommitAuthor}"
        - echo "=================================================="
        - echo ""
        - echo "ğŸ“¦ Installing just command runner..."
        - curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin
        - chmod +x /usr/local/bin/just
        - export PATH="/usr/local/bin:$PATH"
        - just --version
        - echo "Checking prerequisites..."
        - just check-prerequisites
        - echo "âœ… Setup completed successfully"
    Outputs:
      Artifacts:
        - Name: setup-artifacts
          Files:
            - "/usr/local/bin/just"

  # Complete deployment using justfile
  CompleteDeployment:
    Identifier: aws/build@v1
    DependsOn:
      - Setup
    Environment:
      Name: production
      Connections:
        - Name: aws-connection
          Role: CodeCatalystWorkflowDevelopmentRole-AWSCocha
    Inputs:
      Sources:
        - WorkflowSource
      Artifacts:
        - setup-artifacts
    Configuration:
      Commands:
        - echo "Setting up environment..."
        - cp /usr/local/bin/just /usr/local/bin/just || true
        - chmod +x /usr/local/bin/just
        - export PATH="/usr/local/bin:$PATH"
        - echo "ğŸ—ï¸ Running complete deployment pipeline..."
        - just deploy-all-comprehensive
        - echo "ğŸ“Š Deployment completed successfully!"
    Outputs:
      Artifacts:
        - Name: deployment-outputs
          Files:
            - outputs.json
            - deployment-outputs.env
      Reports:
        - Name: deployment-summary
          Format: JUNITXML
          IncludePaths:
            - "deployment-summary.xml"

  # Post-deployment validation
  PostDeploymentValidation:
    Identifier: aws/build@v1
    DependsOn:
      - CompleteDeployment
    Environment:
      Name: production
      Connections:
        - Name: aws-connection
          Role: CodeCatalystWorkflowDevelopmentRole-AWSCocha
    Inputs:
      Sources:
        - WorkflowSource
      Artifacts:
        - setup-artifacts
        - deployment-outputs
    Configuration:
      Commands:
        - echo "Setting up environment..."
        - cp /usr/local/bin/just /usr/local/bin/just || true
        - chmod +x /usr/local/bin/just
        - export PATH="/usr/local/bin:$PATH"
        - echo "Restoring deployment outputs..."
        - cp deployment-outputs.env deployment-outputs.env
        - echo "ğŸ§ª Running post-deployment validation..."
        - just validate-deployment
        - echo "ğŸ“ˆ Running performance tests..."
        - source deployment-outputs.env
        - echo "Installing Apache Bench for load testing..."
        - apt-get update && apt-get install -y apache2-utils
        - echo "Running load test on health endpoint..."
        - ab -n 100 -c 10 "$API_URL/health" || echo "Load test completed with warnings"
        - echo "Running load test on people endpoint..."
        - ab -n 50 -c 5 "$API_URL/people" || echo "Load test completed with warnings"
        - echo "âœ… All validation tests completed"

  # Generate deployment report
  GenerateReport:
    Identifier: aws/build@v1
    DependsOn:
      - PostDeploymentValidation
    Environment:
      Name: production
      Connections:
        - Name: aws-connection
          Role: CodeCatalystWorkflowDevelopmentRole-AWSCocha
    Inputs:
      Sources:
        - WorkflowSource
      Artifacts:
        - setup-artifacts
        - deployment-outputs
    Configuration:
      Commands:
        - echo "Setting up environment..."
        - cp /usr/local/bin/just /usr/local/bin/just || true
        - chmod +x /usr/local/bin/just
        - export PATH="/usr/local/bin:$PATH"
        - echo "Restoring deployment outputs..."
        - cp deployment-outputs.env deployment-outputs.env
        - echo "ğŸ“‹ Generating deployment report..."
        - source deployment-outputs.env
        - echo "# People Register Deployment Report" > deployment-report.md
        - echo "" >> deployment-report.md
        - echo "## Deployment Summary" >> deployment-report.md
        - echo "- **Deployment Date:** $(date)" >> deployment-report.md
        - echo "- **Stack Name:** {{STACK_NAME}}" >> deployment-report.md
        - echo "- **API URL:** $API_URL" >> deployment-report.md
        - echo "- **Frontend URL:** $FRONTEND_URL" >> deployment-report.md
        - echo "- **S3 Bucket:** $S3_BUCKET" >> deployment-report.md
        - echo "- **DynamoDB Table:** $DYNAMODB_TABLE" >> deployment-report.md
        - echo "- **CloudFront Distribution:** $DISTRIBUTION_ID" >> deployment-report.md
        - echo "" >> deployment-report.md
        - echo "## Health Check Results" >> deployment-report.md
        - echo "- API Health: $(curl -s -o /dev/null -w '%{http_code}' $API_URL/health)" >> deployment-report.md
        - echo "- Frontend Status: $(curl -s -o /dev/null -w '%{http_code}' $FRONTEND_URL)" >> deployment-report.md
        - echo "" >> deployment-report.md
        - echo "## Next Steps" >> deployment-report.md
        - echo "- Set up monitoring and alerts" >> deployment-report.md
        - echo "- Configure custom domain names" >> deployment-report.md
        - echo "- Add authentication if needed" >> deployment-report.md
        - echo "- Set up backup and disaster recovery" >> deployment-report.md
        - cat deployment-report.md
        - echo "ğŸ“„ Deployment report generated"
    Outputs:
      Artifacts:
        - Name: deployment-report
          Files:
            - deployment-report.md
            - deployment-outputs.env
